name: Export LPRNet ONNX

on:
  push:
    branches: [ main, master ] # 根据你的主分支名称修改
  workflow_dispatch: # 允许在 GitHub 界面手动点击运行

jobs:
  build-and-export:
    runs-on: ubuntu-latest

    steps:
      # 1. 拉取代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. 安装 uv (根据你的记录，你使用了 uv 进行包管理)
      - name: Install uv
        uses: astral-sh/setup-uv@v3

      # 3. 设置 Python 3.10 (对应记录 10079)
      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # 4. 创建虚拟环境并安装依赖
      # 对应记录: 10081, 10088, 10091
      # 注意：整合了 torch 旧版本、onnx、onnxsim 和 numpy<2 的限制
      - name: Install dependencies
        run: |
          uv venv
          source .venv/bin/activate
          
          # 核心依赖 (Torch 1.13.1, Torchvision 0.14.1)
          uv pip install torch==1.13.1 torchvision==0.14.1
          
          # ONNX 工具链
          uv pip install onnx==1.15.0 onnx-simplifier onnxruntime
          
          # 兼容性修复 (对应记录 10088)
          uv pip install "numpy<2"

      # 5. 运行导出脚本
      # 对应记录: 10094 (python ex.py)
      - name: Run Export Script
        run: |
          source .venv/bin/activate
          python export_onnx.py

      # 6. 运行 ONNX Simplifier
      # 对应记录: 10095
      - name: Simplify ONNX model
        run: |
          source .venv/bin/activate
          python -m onnxsim LPRNet.onnx LPRNet_sim.onnx --overwrite-input-shape "input:1,3,24,94"

      # 7. 检查文件生成情况 (可选，方便调试)
      - name: Check outputs
        run: ls -lh *.onnx

      # 8. 上传产物到 GitHub Actions Summary
      - name: Upload ONNX Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: LPRNet-ONNX-Models
          path: |
            LPRNet.onnx
            LPRNet_sim.onnx
          if-no-files-found: error
